<!DOCTYPE html>

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabla de Prestadores Médicos con Geolocalización</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <!-- PapaParse para CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
        }
        .filtros { 
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }
        .filtros label {
            font-weight: bold;
            margin-right: 5px;
        }
        select { 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            min-width: 200px; 
        }
        table { 
            font-size: 14px; 
            border-collapse: collapse; 
            width: 100%; 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: center;
        }
        th {
            background-color: #497e76; 
            color: white; 
            font-weight: bold;
        }
        .details-control {
            display: block;
            margin: 0 auto;
            width: 40px;
            text-align: center;
            background-color: #497e76;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .details-child {
            background-color: #f9f9f9;
            padding: 20px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        .practices-container {
            column-count: 3;
            column-gap: 15px;
            text-align: left;
        }
        .practice-item {
            break-inside: avoid;
            margin-bottom: 8px;
            padding: 3px;
            background-color: #f0f0f0;
            border-radius: 3px;
        }
        .filtros button {
            padding: 8px 15px;
            background-color: #497e76;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .filtros button:hover {
            background-color: #3a645d;
        }
        .map-container {
            height: 300px;
            width: 100%;
            margin-top: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .map-error {
            padding: 15px;
            background-color: #ffebee;
            color: #b71c1c;
            border-radius: 4px;
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }
        .location-details {
            margin-top: 10px;
            font-style: italic;
            color: #555;
        }
        @media (max-width: 768px) {
            .filtros {
                flex-direction: column;
                align-items: stretch;
            }
            .filtros select {
                width: 100%;
                margin-bottom: 10px;
            }
            .practices-container {
                column-count: 2;
            }
        }
    </style>
</head>
<body>
    <h1 style="color: #497e76; border-bottom: 2px solid #497e76; padding-bottom: 10px;">
        Directorio de Prestadores Médicos
    </h1>
    
    <!-- Filtros -->
    <div class="filtros">
        <div>
            <label>Seccional:</label>
            <select id="filtro-seccional">
                <option value="">Todas</option>
            </select>
        </div>
        
        <div>
            <label>Tipo de Prestador:</label>
            <select id="filtro-tipo">
                <option value="">Todos</option>
            </select>
        </div>
        
        <div>
            <label>Especialidad:</label>
            <select id="filtro-especialidad">
                <option value="">Todas</option>
            </select>
        </div>
        
        <button id="toggle-view-btn" type="button">Ver solo prestadores</button>
    </div>
    
    <!-- Tabla -->
    <table id="tabla-prestadores" class="display">
        <thead>
            <tr>
                <th width="5%"></th>
                <th>Nombre</th>
                <th>N° Prestador</th>
                <th>Seccional</th>
                <th>Tipo de Prestador</th>
                <th>Especialidad</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        // Precargar la relación Tipo de Prestador -> Especialidad
        const tipoEspecialidad = {
            "GuardiaActiva": ["Cardiologica", "Clinica", "General", "Ginecologica", "Obstetrica", "Odontologica", "Oftalmologica", "Otorrinolaringologia", "Pediatrica", "Por Electrocucion", "Por envenenamiento", "Por intoxicacion", "Por mordedura de animales", "Psiquiatrica", "Quemados", "Quirurgica", "Traumatologica"],
            "GuardiaPasiva": ["Cardiologica", "Clinica", "General", "Ginecologica", "Obstetrica", "Oftalmologica", "Otorrinolaringologia", "Pediatrica", "Psiquiatrica", "Quemados", "Quirurgica", "Traumatologica"],
            "EspecialidadesAmbulatorio": ["Adolescencia", "Alergia e Inmunologia", "Alergia e Inmunologia Infantil", "Andrologia", "Cardiologia", "Cardiologia Infantil", "Clinica Medica", "Dermatologia", "Dermatologia Infantil", "Diabetologia", "Diabetologia Infantil", "Endocrinologia", "Endocrinologia Infantil", "Estomatologia", "Fisiatria", "Flebologia y Linfologia", "Fonoaudiologia", "Gastroenterologia", "Gastroenterologia Infantil", "Genetica", "Geriatria", "Ginecologia", "Ginecologia Infanto Juvenil", "Hematologia e Inmunologia", "Hematologia e Inmunologia Infantil", "Hemoterapia", "Hemoterapia Infantil", "Hepatologia", "Infectologia", "Infectologia Infantil", "Medicina Familiar", "Micologia", "Nefrologia", "Nefrologia Infantil", "Neonatologia", "Neumonologia", "Neumonologia Infantil", "Neurocirugia", "Neurologia", "Neurologia Infantil", "Nutricion", "Nutricion Infantil", "Obstetricia", "Odontologia", "Oftalmologia", "Oftalmologia Infantil", "Oncologia", "Oncologia Infantil", "Osteoporosis y Litiasis renal", "Otorrinolaringologia", "Otorrinolaringologia Infantil", "Patologia Mamaria", "Pediatria", "Proctologia", "Psicologia", "Psiquiatria", "Psiquiatria Infantil", "Quemados", "Reumatologia", "Traumatologia y Ortopedia", "Traumatologia y Ortopedia Infantil", "Urologia", "Urologia Infantil"],
            "Internacion": ["Internacion Cardiologica", "Internacion Neurologia", "Internacion Oftalmologica", "Internacion Otorrinolaringologica", "Internacion por Rehabilitacion", "Internacion Psiquiatrica", "Internacion Traumatologica", "Maternidad", "Pediatrica", "Piso", "Respirador", "Telemetria", "Terapia Intermedia", "UCO", "UTI", "UTINeo", "UTIP"],
            "Cirugias": ["Artroscopica", "Cabeza y Cuello", "Cardiaca", "Cardiaca Infantil", "Endoscopica", "General", "Ginecologia", "Infantil", "Laparoscopica", "Miembro Superior y Mano", "Nariz y oido", "Neurocirugia", "Oftalmologica", "Pierna y Pie", "Plastica Reparadora", "Toracica", "Urologia", "Vascular Periferica"],
            "Diagnostico": ["Anatomia Patologia", "Audiometria", "Camara Gamma - Medicina Nuclear - Radioisotopos", "Campo visual computarizado", "Colposcopia", "Densitometria Osea", "Drenaje Linfatico", "Eco-Doppler", "Ecografia", "Ecografia Infantil", "Eco Estres", "Electrocardiograma", "Electroencefalograma", "Electromiograma", "Endoscopia Digestiva", "Endoscopia Ginecologica", "Endoscopia Respiratoria", "Endoscopia Urologica", "Ergometria", "Espinograma", "Espirometria", "Espirometria Infantil", "Estudios mamarios", "Fonoaudiologia y Foniatria", "Hemodinamia", "Holter", "Infiltraciones", "Kinesiologia", "Kinesiologia en interancion", "Laboratorio Alergia e Inmunologia", "Laboratorio Bacteriologia y Serologia", "Laboratorio Dosaje Hormonal", "Laboratorio Estudios Metabolicos - Fosfacalcicos", "Laboratorio Estudios Nefrologicos", "Laboratorio Hematologia - Hemostasia - Trombosis", "Laboratorio Micologia", "Laboratorio Radioinmunoensayo", "Laboratorio Virologia", "Litotricia", "Mapeo Cerebral", "Monitoreo Fetal", "PET", "Polisomnografia", "Potenciales Evocados", "Presurometria", "Psicologia", "Psicologia Infantil", "Psicopedagogia", "Psicoprofilaxis del parto", "Puncion Mamaria", "Puncion Tiroide", "Quimioterapia", "Radiologia", "Radiologia Infantil", "Radioterapia", "Rehabilitacion Cardiaca", "Rehabilitacion Vestibular", "Resonador abierto", "Resonancia Magnetica Nuclear", "RPG", "Tomografia Computada", "Tomografo abierto", "Urodinamia", "Urodinamia Infantil"]
        };

        // Precargar Seccionales
        const seccionales = [
            "BAHIA BLANCA", "BUENOS AIRES ZONA 1", "BUENOS AIRES ZONA 2", "BUENOS AIRES ZONA 3", "CAPITAL", 
            "CATAMARCA", "CHACO", "CHUBUT", "CORDOBA", "CORRIENTES", "ENTRE RIOS", "FORMOSA", 
            "GBA NOROESTE", "GBA NORTE", "GBA OESTE", "GBA SUR", "JUJUY", "LA PAMPA", "LA PLATA", 
            "LA RIOJA", "MAR DEL PLATA", "MENDOZA", "MISIONES", "NEUQUEN", "RIO NEGRO", "ROSARIO", 
            "SALTA", "SAN JUAN", "SAN LUIS", "SANTA CRUZ", "SANTA FE", "SANTIAGO DEL ESTERO", 
            "TIERRA DEL FUEGO", "TRENQUE LAUQUEN", "TUCUMAN"
        ];

        $(document).ready(function() {
            // Cache para geolocalizaciones
            const geocodeCache = {};
            
            // Cargar opciones de Seccional
            seccionales.forEach(sec => {
                $('#filtro-seccional').append(`<option value="${sec}">${sec}</option>`);
            });

            // Cargar opciones de Tipo de Prestador
            Object.keys(tipoEspecialidad).forEach(tipo => {
                $('#filtro-tipo').append(`<option value="${tipo}">${tipo}</option>`);
            });

            // Actualizar Especialidades según Tipo de Prestador seleccionado
            $('#filtro-tipo').on('change', function() {
                const tipo = $(this).val();
                $('#filtro-especialidad').empty().append('<option value="">Todas</option>');

                if (tipo) {
                    tipoEspecialidad[tipo].forEach(esp => {
                        $('#filtro-especialidad').append(`<option value="${esp}">${esp}</option>`);
                    });
                }
            });

            // Función para geocodificar una dirección
            async function geocodeAddress(address) {
                if (!address) return null;
                
                // Verificar si ya está en caché
                if (geocodeCache[address]) {
                    return geocodeCache[address];
                }
                
                try {
                    // Usar el servicio de Nominatim (OpenStreetMap)
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`
                    );
                    const data = await response.json();
                    
                    if (data.length > 0) {
                        const result = {
                            lat: parseFloat(data[0].lat),
                            lon: parseFloat(data[0].lon),
                            displayName: data[0].display_name
                        };
                        geocodeCache[address] = result;
                        return result;
                    }
                } catch (error) {
                    console.error("Error en geocodificación:", error);
                }
                return null;
            }

            // Función para inicializar un mapa
            function initMap(containerId, lat, lon, providerName) {
                const map = L.map(containerId).setView([lat, lon], 16);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                
                L.marker([lat, lon])
                    .addTo(map)
                    .bindPopup(`<b>${providerName}</b><br>${lat.toFixed(6)}, ${lon.toFixed(6)}`)
                    .openPopup();
                    
                return map;
            }

            // Cargar datos desde CSV
            Papa.parse("Data.csv", {
                download: true,
                header: true,
                delimiter: ";",
                complete: function(results) {
                    const datosFiltrados = results.data.filter(row => row.CUIT && row.CUIT.trim() !== "");

                    // Agrupar proveedores por CUIT y Domicilio (para diferenciar sucursales)
                    const providersMap = {};
                    datosFiltrados.forEach(row => {
                        const key = `${row.CUIT}-${row.Domicilio}`; // Clave única por CUIT y Domicilio
                        if (!providersMap[key]) {
                            providersMap[key] = {
                                CUIT: row.CUIT,
                                Nombre: row.Nombre,
                                NroPrestador: row.NroPrestador,
                                Seccional: row.Seccional,
                                Provincia: row.Provincia,
                                Partido: row.Partido,
                                Localidad: row.Localidad,
                                Domicilio: row.Domicilio,
                                Telefono: row.Telefono,
                                practices: [] // Array para prácticas
                            };
                        }
                        providersMap[key].practices.push({
                            tipo: row['Tipo de prestador'],
                            especialidad: row['Especialidad']
                        });
                    });

                    // Convertir el objeto en un array para la vista compacta
                    const providersCompact = Object.values(providersMap);
                    
                    // Configurar DataTables
                    const tabla = $('#tabla-prestadores').DataTable({
                        data: datosFiltrados,
                        columns: [
                            { 
                                data: null, 
                                defaultContent: '<button class="details-control" title="Ver detalles">+</button>',
                                orderable: false 
                            },
                            { data: 'Nombre', defaultContent: '' },
                            { data: 'NroPrestador', defaultContent: '' },
                            { data: 'Seccional', defaultContent: '' },
                            { data: 'Tipo de prestador', defaultContent: '' },
                            { data: 'Especialidad', defaultContent: '' }
                        ],
                        language: {
                            url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
                        },
                        pageLength: 10,
                        lengthMenu: [5, 10, 20, 50]
                    });

                    // Variables para gestionar el modo de vista (clásico y compacto)
                    let currentViewMode = 'classic'; // Modo inicial

                    // Manejar clic en el botón de detalles
                    $('#tabla-prestadores tbody').on('click', 'button.details-control', function () {
                        const tr = $(this).closest('tr');
                        const row = tabla.row(tr);
                        const rowData = row.data();

                        if (row.child.isShown()) {
                            // Si ya se muestra la información, ocultarla
                            row.child.hide();
                            tr.removeClass('shown');
                            $(this).text('+').attr('title', 'Ver detalles');
                        } else {
                            $(this).text('-').attr('title', 'Ocultar detalles');
                            
                            // Crear el contenido para la fila expandida
                            let expandedData;
                            if (currentViewMode === 'compact') {
                                // Buscar datos completos del proveedor en vista compacta
                                const providerDetails = providersCompact.find(p => 
                                    p.Nombre === rowData.Nombre && 
                                    p.NroPrestador === rowData.NroPrestador &&
                                    p.Domicilio === rowData.Domicilio
                                );
                                expandedData = getProviderDetails(rowData, providerDetails);
                            } else {
                                expandedData = createDetailsRow(rowData);
                            }
                            
                            row.child(expandedData).show();
                            tr.addClass('shown');
                            
                            // Preparar para geolocalización
                            const fullAddress = [
                                rowData.Domicilio,
                                rowData.Localidad,
                                rowData.Partido,
                                rowData.Provincia
                            ].filter(Boolean).join(', ');
                            
                            const mapContainerId = `map-${rowData.CUIT}-${rowData.Domicilio ? rowData.Domicilio.replace(/\W+/g, '-') : 'unknown'}`;
                            
                            // Geocodificar y mostrar mapa
                            setTimeout(async () => {
                                const mapElement = document.getElementById(mapContainerId);
                                if (mapElement) {
                                    const coords = await geocodeAddress(fullAddress);
                                    
                                    if (coords) {
                                        initMap(mapContainerId, coords.lat, coords.lon, rowData.Nombre);
                                        
                                        // Mostrar información detallada
                                        const locationDetails = document.getElementById(`${mapContainerId}-details`);
                                        if (locationDetails) {
                                            locationDetails.innerHTML = `
                                                <div><b>Coordenadas:</b> ${coords.lat.toFixed(6)}, ${coords.lon.toFixed(6)}</div>
                                                <div><b>Dirección completa:</b> ${coords.displayName}</div>
                                            `;
                                        }
                                    } else {
                                        mapElement.innerHTML = `<div class="map-error">Ubicación no encontrada: ${fullAddress || 'Sin dirección'}</div>`;
                                    }
                                }
                            }, 300);
                        }
                    });

                    // Obtener detalles del proveedor para la vista compacta
                    function getProviderDetails(detalles, providerDetails) {
                        if (!providerDetails) return `<div class="details-child">Error: Datos no disponibles</div>`;
                        
                        const practices = providerDetails.practices?.map(
                            p => `<div class="practice-item">${p.tipo} - ${p.especialidad}</div>`
                        ).join('') || '<div class="practice-item">Sin prácticas registradas</div>';
                        
                        const uniqueId = `map-${providerDetails.CUIT}-${providerDetails.Domicilio.replace(/\W+/g, '-')}`;
                        
                        return `
                            <div class="details-child">
                                <table style="width:100%;">
                                    <tr><th>Provincia:</th><td>${providerDetails.Provincia || 'N/A'}</td></tr>
                                    <tr><th>Partido:</th><td>${providerDetails.Partido || 'N/A'}</td></tr>
                                    <tr><th>Localidad:</th><td>${providerDetails.Localidad || 'N/A'}</td></tr>
                                    <tr><th>Domicilio:</th><td>${providerDetails.Domicilio || 'N/A'}</td></tr>
                                    <tr><th>Teléfono:</th><td>${providerDetails.Telefono || 'N/A'}</td></tr>
                                    <tr><th>Prácticas:</th><td><div class="practices-container">${practices}</div></td></tr>
                                    <tr><th colspan="2">Ubicación Geográfica</th></tr>
                                    <tr><td colspan="2">
                                        <div id="${uniqueId}" class="map-container"></div>
                                        <div id="${uniqueId}-details" class="location-details">
                                            Buscando ubicación...
                                        </div>
                                    </td></tr>
                                </table>
                            </div>`;
                    }

                    // Crear el contenido de la fila expandida para la vista clásica
                    function createDetailsRow(detalles) {
                        const uniqueId = `map-${detalles.CUIT}-${detalles.Domicilio.replace(/\W+/g, '-')}`;
                        
                        return `
                            <div class="details-child">
                                <table style="width:100%;">
                                    <tr><th>Provincia:</th><td>${detalles.Provincia || 'N/A'}</td></tr>
                                    <tr><th>Partido:</th><td>${detalles.Partido || 'N/A'}</td></tr>
                                    <tr><th>Localidad:</th><td>${detalles.Localidad || 'N/A'}</td></tr>
                                    <tr><th>Domicilio:</th><td>${detalles.Domicilio || 'N/A'}</td></tr>
                                    <tr><th>Teléfono:</th><td>${detalles.Telefono || 'N/A'}</td></tr>
                                    <tr><th colspan="2">Ubicación Geográfica</th></tr>
                                    <tr><td colspan="2">
                                        <div id="${uniqueId}" class="map-container"></div>
                                        <div id="${uniqueId}-details" class="location-details">
                                            Buscando ubicación...
                                        </div>
                                    </td></tr>
                                </table>
                            </div>`;
                    }

                    // Botón para alternar entre las vistas
                    $('#toggle-view-btn').click(function() {
                        currentViewMode = (currentViewMode === 'classic') ? 'compact' : 'classic';

                        if (currentViewMode === 'compact') {
                            tabla.clear().rows.add(providersCompact).draw();
                            tabla.columns([4, 5]).visible(false);
                            $(this).text('Ver vista completa');
                        } else {
                            tabla.clear().rows.add(datosFiltrados).draw();
                            tabla.columns([4, 5]).visible(true);
                            $(this).text('Ver solo prestadores');
                        }
                        // Cerrar detalles abiertos
                        tabla.rows().every(function() {
                            if (this.child.isShown()) {
                                this.child.hide();
                                $(this.node()).removeClass('shown');
                                $(this.node()).find('.details-control').text('+').attr('title', 'Ver detalles');
                            }
                        });
                        tabla.columns.adjust().draw();
                    });

                    // Aplicar filtros
                    $('.filtros select').on('change', function() {
                        const seccional = $('#filtro-seccional').val();
                        const tipo = $('#filtro-tipo').val();
                        const especialidad = $('#filtro-especialidad').val();

                        tabla.column(3).search(seccional).draw();     // Seccional
                        tabla.column(4).search(tipo).draw();          // Tipo de prestador
                        tabla.column(5).search(especialidad).draw();  // Especialidad
                    });
                }
            });
        });
    </script>
</body>
</html>
