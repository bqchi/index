<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directorio de Prestadores Médicos</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin:20px; background:#f5f5f5;}
        h1 { color: #497e76; }
        .filtros { margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap;}
        select, button { padding: 8px; border-radius:4px; border:1px solid #bbb; }
        .filtros button { background:#497e76; color:white; border:none; min-width:160px;}
        table { font-size: 15px;}
        th, td { text-align: center;}
        .details-child { background: #f9f9f9; padding: 18px;}
        .practices-container { column-count:2; column-gap:20px; text-align:left;}
        .practice-item { break-inside:avoid; margin-bottom:8px; background:#e5f4ea; padding:4px 7px; border-radius:3px;}
        .map-container { height: 220px; width: 99%; margin-top:10px; border-radius:6px; border:1px solid #497e76;}
    </style>
</head>
<body>
    <h1>Tabla de Prestadores Médicos</h1>
    <div class="filtros">
        <label>Seccional:
            <select id="filtro-seccional"><option value="">Todas</option></select>
        </label>
        <label>Tipo de Prestador:
            <select id="filtro-tipo"><option value="">Todos</option></select>
        </label>
        <button id="toggle-view-btn" type="button">Ver solo los prestadores</button>
    </div>
    <table id="tabla-prestadores" class="display" style="width:100%;">
        <thead>
            <tr>
                <th></th>
                <th>Nombre</th>
                <th>Nro Prestador</th>
                <th>Seccional</th>
                <th>Tipo de Prestador</th>
                <th>Especialidad</th>
                <th>Plan</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
<script>
// Función para formatear el tipo de prestador (ej: "GuardiaPasiva" → "Guardia Pasiva")
function formatTipoDisplay(tipo) {
    if (tipo === "Diagnostico") return "Diagnostico y Tratamiento";
    return tipo.replace(/([a-z])([A-Z])/g, '$1 $2');
}

const tipoEspecialidad = {
    "GuardiaActiva": ["Cardiologica","Clinica","General","Ginecologica","Obstetrica","Odontologica","Oftalmologica","Otorrinolaringologia","Pediatrica","Por Electrocucion","Por envenenamiento","Por intoxicacion","Por mordedura de animales","Psiquiatrica","Quemados","Quirurgica","Traumatologica"],
    "GuardiaPasiva": ["Cardiologica","Clinica","General","Ginecologica","Obstetrica","Oftalmologica","Otorrinolaringologia","Pediatrica","Psiquiatrica","Quemados","Quirurgica","Traumatologica"],
    "EspecialidadesAmbulatorio": ["Adolescencia","Alergia e Inmunologia","Alergia e Inmunologia Infantil","Andrologia","Cardiologia","Cardiologia Infantil","Clinica Medica","Dermatologia","Dermatologia Infantil","Diabetologia","Diabetologia Infantil","Endocrinologia","Endocrinologia Infantil","Estomatologia","Fisiatria","Flebologia y Linfologia","Fonoaudiologia","Gastroenterologia","Gastroenterologia Infantil","Genetica","Geriatria","Ginecologia","Ginecologia Infanto Juvenil","Hematologia e Inmunologia","Hematologia e Inmunologia Infantil","Hemoterapia","Hemoterapia Infantil","Hepatologia","Infectologia","Infectologia Infantil","Medicina Familiar","Micologia","Nefrologia","Nefrologia Infantil","Neonatologia","Neumonologia","Neumonologia Infantil","Neurocirugia","Neurologia","Neurologia Infantil","Nutricion","Nutricion Infantil","Obstetricia","Odontologia","Oftalmologia","Oftalmologia Infantil","Oncologia","Oncologia Infantil","Osteoporosis y Litiasis renal","Otorrinolaringologia","Otorrinolaringologia Infantil","Patologia Mamaria","Pediatria","Proctologia","Psicologia","Psiquiatria","Psiquiatria Infantil","Quemados","Reumatologia","Traumatologia y Ortopedia","Traumatologia y Ortopedia Infantil","Urologia","Urologia Infantil"],
    "Internacion": ["Internacion Cardiologica","Internacion Neurologia","Internacion Oftalmologica","Internacion Otorrinolaringologica","Internacion por Rehabilitacion","Internacion Psiquiatrica","Internacion Traumatologica","Maternidad","Pediatrica","Piso","Respirador","Telemetria","Terapia Intermedia","UCO","UTI","UTINeo","UTIP"],
    "Cirugias": ["Artroscopica","Cabeza y Cuello","Cardiaca","Cardiaca Infantil","Endoscopica","General","Ginecologia","Infantil","Laparoscopica","Miembro Superior y Mano","Nariz y oido","Neurocirugia","Oftalmologica","Pierna y Pie","Plastica Reparadora","Toracica","Urologia","Vascular Periferica"],
    "Diagnostico": ["Anatomia Patologia","Audiometria","Camara Gamma - Medicina Nuclear - Radioisotopos","Campo visual computarizado","Colposcopia","Densitometria Osea","Drenaje Linfatico","Eco-Doppler","Ecografia","Ecografia Infantil","Eco Estres","Electrocardiograma","Electroencefalograma","Electromiograma","Endoscopia Digestiva","Endoscopia Ginecologica","Endoscopia Respiratoria","Endoscopia Urologica","Ergometria","Espinograma","Espirometria","Espirometria Infantil","Estudios mamarios","Fonoaudiologia y Foniatria","Hemodinamia","Holter","Infiltraciones","Kinesiologia","Kinesiologia en interancion","Laboratorio Alergia e Inmunologia","Laboratorio Bacteriologia y Serologia","Laboratorio Dosaje Hormonal","Laboratorio Estudios Metabolicos - Fosfacalcicos","Laboratorio Estudios Nefrologicos","Laboratorio Hematologia - Hemostasia - Trombosis","Laboratorio Micologia","Laboratorio Radioinmunoensayo","Laboratorio Virologia","Litotricia","Mapeo Cerebral","Monitoreo Fetal","PET","Polisomnografia","Potenciales Evocados","Presurometria","Psicologia","Psicologia Infantil","Psicopedagogia","Psicoprofilaxis del parto","Puncion Mamaria","Puncion Tiroide","Quimioterapia","Radiologia","Radiologia Infantil","Radioterapia","Rehabilitacion Cardiaca","Rehabilitacion Vestibular","Resonador abierto","Resonancia Magnetica Nuclear","RPG","Tomografia Computada","Tomografo abierto","Urodinamia","Urodinamia Infantil"]
};
const seccionales = ["BAHIA BLANCA","BUENOS AIRES ZONA 1","BUENOS AIRES ZONA 2","BUENOS AIRES ZONA 3","CAPITAL","CATAMARCA","CHACO","CHUBUT","CORDOBA","CORRIENTES","ENTRE RIOS","FORMOSA","GBA NOROESTE","GBA NORTE","GBA OESTE","GBA SUR","JUJUY","LA PAMPA","LA PLATA","LA RIOJA","MAR DEL PLATA","MENDOZA","MISIONES","NEUQUEN","RIO NEGRO","ROSARIO","SALTA","SAN JUAN","SAN LUIS","SANTA CRUZ","SANTA FE","SANTIAGO DEL ESTERO","TIERRA DEL FUEGO","TRENQUE LAUQUEN","TUCUMAN"];

$(function() {
    seccionales.forEach(sec => $('#filtro-seccional').append(`<option value="${sec}">${sec}</option>`));
    Object.keys(tipoEspecialidad).forEach(tipo => $('#filtro-tipo').append(`<option value="${tipo}">${formatTipoDisplay(tipo)}</option>`));

    let providersCompact = [], datosFiltrados = [], tabla, currentViewMode = 'classic';

    Papa.parse("Data.csv", {
        download: true,
        header: true,
        delimiter: ";",
        encoding: "UTF-8", // Asegura que la "ñ" se lea correctamente
        complete: function(results) {
            datosFiltrados = results.data.filter(row => row.CUIT && row.CUIT.trim() !== "");
            const providersMap = {};
            datosFiltrados.forEach(row => {
                const key = `${row.CUIT}-${row.Domicilio}`;
                if (!providersMap[key]) {
                    providersMap[key] = {
                        CUIT: row.CUIT,
                        Nombre: row.Nombre,
                        NroPrestador: row.NroPrestador,
                        Seccional: row.Seccional,
                        Provincia: row.Provincia,
                        Partido: row.Partido,
                        Localidad: row.Localidad,
                        Domicilio: row.Domicilio,
                        Telefono: row.Telefono,
                        Plan: new Set(),
                        practices: []
                    };
                }
                if (row.Plan) providersMap[key].Plan.add(row.Plan);
                providersMap[key].practices.push({
                    tipo: row['Tipo de prestador'],
                    especialidad: row['Especialidad'],
                    plan: row.Plan
                });
            });
            // Convertir Set de Planes a cadena
            Object.keys(providersMap).forEach(key => {
                providersMap[key].Plan = Array.from(providersMap[key].Plan).join(', ');
            });
            providersCompact = Object.values(providersMap);

            tabla = $('#tabla-prestadores').DataTable({
                data: datosFiltrados,
                columns: [
                    {data: null, defaultContent: '<button class="details-control">+</button>', orderable: false },
                    {data: 'Nombre', defaultContent: '' },
                    {data: 'NroPrestador', defaultContent: '' },
                    {data: 'Seccional', defaultContent: '' },
                    {data: 'Tipo de prestador', render: function(data) { return formatTipoDisplay(data); }},
                    {data: 'Especialidad', defaultContent: '' },
                    {data: 'Plan', defaultContent: ''}
                ],
                language: {url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'}
            });

            // Filtros
            $('.filtros select').on('change', function() {
                tabla.column(3).search($('#filtro-seccional').val()).draw();
                tabla.column(4).search($('#filtro-tipo').val()).draw();
            });

            // Botón vista compacta/completa
            $('#toggle-view-btn').click(function() {
                currentViewMode = (currentViewMode === 'classic') ? 'compact' : 'classic';
                if (currentViewMode === 'compact') {
                    tabla.clear().rows.add(providersCompact).draw();
                    tabla.columns([4,5]).visible(false);
                    $(this).text('Ver vista completa');
                } else {
                    tabla.clear().rows.add(datosFiltrados).draw();
                    tabla.columns([4,5]).visible(true);
                    $(this).text('Ver solo los prestadores');
                }
                tabla.rows().every(function(){ if(this.child.isShown()) this.child.hide(); $(this.node()).removeClass('shown');});
                tabla.columns.adjust().draw();
            });

            // Mostrar/ocultar detalles + mapa
            $('#tabla-prestadores tbody').on('click', 'button.details-control', async function () {
                const tr = $(this).closest('tr'), row = tabla.row(tr), rowData = row.data();
                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                    $(this).text('+');
                } else {
                    $(this).text('-');
                    const provider = currentViewMode === 'compact' 
                        ? providersCompact.find(p => p.Nombre === rowData.Nombre && p.NroPrestador === rowData.NroPrestador && p.Domicilio === rowData.Domicilio)
                        : rowData;
                    
                    // Construir la lista de prácticas con el plan
                    let practicesToShow;
                    if (currentViewMode === 'compact') {
                        practicesToShow = provider.practices;
                    } else {
                        practicesToShow = [{
                            tipo: rowData['Tipo de prestador'],
                            especialidad: rowData['Especialidad'],
                            plan: rowData.Plan
                        }];
                    }
                    let practicesHtml = '';
                    if (practicesToShow.length) {
                        practicesHtml = practicesToShow.map(p => 
                            `<div class="practice-item">${formatTipoDisplay(p.tipo)} - ${p.especialidad} (${p.plan})</div>`
                        ).join('');
                        practicesHtml = `<div class="practices-container">${practicesHtml}</div>`;
                    } else {
                        practicesHtml = 'Sin prácticas';
                    }

                    const mapId = `mapa-${(provider.CUIT||rowData.CUIT).replace(/\W/g,'')}-${(provider.Domicilio||rowData.Domicilio).replace(/\W/g,'')}`;
                    let detalleHtml = `
                    <div class="details-child">
                        <table style="width:100%;">
                            <tr><th>Provincia:</th><td>${provider.Provincia||'N/A'}</td></tr>
                            <tr><th>Partido:</th><td>${provider.Partido||'N/A'}</td></tr>
                            <tr><th>Localidad:</th><td>${provider.Localidad||'N/A'}</td></tr>
                            <tr><th>Domicilio:</th><td>${provider.Domicilio||'N/A'}</td></tr>
                            <tr><th>Telefono:</th><td>${provider.Telefono||'N/A'}</td></tr>
                            <tr><th>Practicas:</th><td>${practicesHtml}</td></tr>
                            <tr><th>Ubicacion:</th>
                                <td>
                                    <div id="${mapId}" class="map-container"></div>
                                </td>
                            </tr>
                        </table>
                    </div>`;
                    row.child(detalleHtml).show();
                    tr.addClass('shown');
                    // Geocodificación y mapa
                    const address = [provider.Domicilio||rowData.Domicilio, provider.Localidad||rowData.Localidad, provider.Partido||rowData.Partido, provider.Provincia||rowData.Provincia].filter(Boolean).join(", ");
                    const coords = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                        .then(r=>r.json()).then(d=>d[0] ? {lat:+d[0].lat, lon:+d[0].lon} : null).catch(()=>null);
                    if (coords) {
                        const map = L.map(mapId).setView([coords.lat, coords.lon], 16);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'OpenStreetMap'}).addTo(map);
                        L.marker([coords.lat, coords.lon]).addTo(map).bindPopup(address).openPopup();
                    } else {
                        document.getElementById(mapId).innerHTML = "<div style='color:#b71c1c;padding:30px;text-align:center;'>No se pudo localizar la direccion.</div>";
                    }
                }
            });
        }
    });
});
</script>
</body>
</html>
