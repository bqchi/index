<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directorio de Prestadores Médicos</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin:20px; background:#f5f5f5;}
        h1 { color: #497e76; }
        .filtros { 
            margin-bottom: 20px; 
            display: flex; 
            gap: 15px; 
            flex-wrap: wrap;
            align-items: center;
        }
        select, button { 
            padding: 8px; 
            border-radius:4px; 
            border:1px solid #bbb; 
            font-size: 14px;
        }
        .filtros button { 
            background:#497e76; 
            color:white; 
            border:none; 
            min-width:120px;
        }
        .filtros .reset-btn { 
            background: #8c4a4a; 
        }
        table { 
            font-size: 14px; 
            width: 100% !important;
        }
        th, td { 
            text-align: center; 
            padding: 6px 10px !important;
        }
        #tabla-prestadores tbody tr td:nth-child(2) {  /* Columna Nombre */
            max-width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .details-child { 
            background: #f9f9f9; 
            padding: 15px;
        }
        .practices-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
        }
        .practice-type-container { 
            flex: 1 0 280px; 
            background: #e5f4ea; 
            padding: 10px; 
            border-radius: 6px; 
        }
        .practice-type-title { 
            font-weight: bold; 
            margin-bottom: 8px; 
            text-align: center;
            color: #497e76;
        }
        .practice-list { 
            padding-left: 15px; 
            text-align: left; 
        }
        .map-container { 
            height: 220px; 
            width: 99%; 
            margin-top:10px; 
            border-radius:6px; 
            border:1px solid #497e76;
        }
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Directorio de Prestadores Médicos</h1>
    <div class="filtros">
        <label>Seccional:
            <select id="filtro-seccional"><option value="">Todas</option></select>
        </label>
        <label>Tipo:
            <select id="filtro-tipo"><option value="">Todos</option></select>
        </label>
        <label>Especialidad:
            <select id="filtro-especialidad"><option value="">Todas</option></select>
        </label>
        <label>Plan:
            <select id="filtro-plan"><option value="">Todos</option></select>
        </label>
        <button id="reset-btn" type="button" class="reset-btn">Borrar Filtros</button>
    </div>
    <table id="tabla-prestadores" class="display">
        <thead>
            <tr>
                <th></th>
                <th>Nombre</th>
                <th>Nro Prestador</th>
                <th>Seccional</th>
                <th>Plan</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
<script>
const tipoEspecialidad = {
    "GuardiaActiva": ["Cardiológica","Clínica","General","Ginecológica","Obstétrica","Odontológica","Oftalmológica","Otorrinolaringología","Pedriática","Por Electrocusión","Por envenenamiento","Por intoxicación","Por mordedura de animales","Psiquiátrica","Quemados","Quirúrgica","Traumatológica"],
    "GuardiaPasiva": ["Cardiológica","Clínica","General","Ginecológica","Obstétrica","Oftalmológica","Otorrinolaringología","Pedriática","Psiquiátrica","Quemados","Quirúrgica","Traumatológica"],
    "EspecialidadesAmbulatorio": ["Adolescencia","Alergia e Inmunología","Alergia e Inmunología Infantil","Andrología","Cardiología","Cardiología Infantil","Clínica Médica","Dermatología","Dermatología Infantil","Diabetología","Diabetología Infantil","Endocrinología","Endocrinología Infantil","Estomatología","Fisiatría","Flebología y Linfología","Fonoaudiología","Gastroenterologí","Gastroenterología Infantil","Genética","Geriatría","Ginecología","Ginecología Infanto Juvenil","Hematología e Inmunología","Hematología e Inmunología Infantil","Hemoterapia","Hemoterapia Infantil","Hepatología","Infectología","Infectología Infantil","Medicina Familiar","Micología","Nefrología","Nefrología Infantil","Neonatología","Neumonología","Neumonología Infantil","Neurocirugía","Neurología","Neurología Infantil","Nutrición","Nutrición Infantil","Obstetricia","Odontología","Oftalmología","Oftalmología Infantil","Oncología","Oncología Infantil","Osteoporosis y Litiasis renal","Otorrinolaringología","Otorrinolaringología Infantil","Patologí Mamaria","Pediatría","Proctología","Psicología","Psiquiatría","Psiquiatría Infantil","Quemados","Reumatología","Traumatología y Ortopedia","Traumatología y Ortopedia Infantil","Urología","Urología Infantil"],
    "Internación": ["Internación Cardiológica","Internación Neurología","Internación Oftalmológica","Internación Otorrinolaringológica","Internación por Rehabilitación","Internación Psiquiátrica","Internación Traumatológica","Maternidad","Pedriátrica","Piso","Respirador","Telemetría","Terapia Intermedia","UCO","UTI","UTINeo","UTIP"],
    "Cirugías": ["Artroscópica","Cabeza y Cuello","Cardíaca","Cardíaca Infantil","Endoscópica","General","Ginecología","Infantil","Laparoscópica","Miembro Superior y Mano","Nariz y oído","Neurocirugía","Oftalmológica","Pierna y Pie","Plástica Reparadora","Torácica","Urología","Vascular Periférica"],
    "Diagnóstico": ["Anatomía Patológica","Audiometría","Cámara Gamma - Medicina Nuclear - Radioisótopos","Campo visual computarizado","Colposcopía","Densitometría Ósea","Drenaje Linfático","Eco-Doppler","Ecografía","Ecografía Infantil","Eco Estres","Electrocardiograma","Electroencefalograma","Electromiograma","Endoscopía Digestiva","Endoscopía Ginecológica","Endoscopía Respiratoria","Endoscopía Urológica","Ergometría","Espinograma","Espirometría","Espirometría Infantil","Estudios mamarios","Fonoaudiología y Foniatría","Hemodinamia","Holter","Infiltraciones","Kinesiología","Kinesiología en internación","Laboratorio Alergia e Inmunología","Laboratorio Bacteriología y Serología","Laboratorio Dosaje Hormonal","Laboratorio Estudios Metabólicos - Fosfocálcicos","Laboratorio Estudios Nefrológicos","Laboratorio Hematología - Hemostasia - Trombosis","Laboratorio Micología","Laboratorio Radioinmunoensayo","Laboratorio Virología","Litotricia","Mapeo Cerebral","Monitoreo Fetal","PET","Polisomnografía","Potenciales Evocados","Presurometría","Psicología","Psicología Infantil","Psicopedagogía","Psicoprofilaxis del parto","Punción Mamaria","Punción Tiroide","Quimioterapia","Radiología","Radiología Infantil","Radioterapia","Rehabilitación Cardíaca","Rehabilitación Vestibular","Resonador abierto","Resonancia Magnética Nuclear","RPG","Tomografía Computada","Tomógrafo abierto","Urodinamia","Urodinamia Infantil"]
};

$(function() {
    let providersCompact = [], datosFiltrados = [], tabla;
    let uniqueSeccionales = new Set();
    let uniquePlans = new Set();

    Papa.parse("Data.csv", {
        download: true,
        header: true,
        delimiter: ";",
        encoding: "UTF-8",
        complete: function(results) {
            datosFiltrados = results.data.filter(row => row.CUIT && row.CUIT.trim() !== "");
            const providersMap = {};

            // Procesar datos y recopilar seccionales y planes únicos
            datosFiltrados.forEach(row => {
                const key = `${row.CUIT}-${row.Domicilio}`;
                if (!providersMap[key]) {
                    providersMap[key] = {
                        CUIT: row.CUIT,
                        Nombre: row.Nombre,
                        NroPrestador: row.NroPrestador,
                        Seccional: row.Seccional,
                        Provincia: row.Provincia,
                        Partido: row.Partido,
                        Localidad: row.Localidad,
                        Domicilio: row.Domicilio,
                        Telefono: row.Telefono,
                        Plan: new Set(),
                        practices: []
                    };
                    if (row.Seccional) uniqueSeccionales.add(row.Seccional);
                }
                if (row.Plan) {
                    providersMap[key].Plan.add(row.Plan);
                    uniquePlans.add(row.Plan);
                }
                providersMap[key].practices.push({
                    tipo: row['Tipo de prestador'],
                    especialidad: row['Especialidad']
                });
            });

            // Llenar selects con datos únicos
            Array.from(uniqueSeccionales).sort().forEach(sec => 
                $('#filtro-seccional').append(`<option value="${sec}">${sec}</option>`));
            
            Object.keys(tipoEspecialidad).forEach(tipo => 
                $('#filtro-tipo').append(`<option value="${tipo}">${tipo}</option>`));
            
            Array.from(uniquePlans).sort().forEach(plan => 
                $('#filtro-plan').append(`<option value="${plan}">${plan}</option>`));

            // Convertir Set de Planes a string para cada proveedor
            Object.keys(providersMap).forEach(key => {
                providersMap[key].Plan = Array.from(providersMap[key].Plan).join(', ');
            });
            providersCompact = Object.values(providersMap);

            // Inicializar DataTable
            tabla = $('#tabla-prestadores').DataTable({
                data: providersCompact,
                columns: [
                    {data: null, defaultContent: '<button class="details-control">+</button>', orderable: false },
                    {data: 'Nombre' },
                    {data: 'NroPrestador' },
                    {data: 'Seccional' },
                    {data: 'Plan' }
                ],
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
                },
                pageLength: 25,
                lengthMenu: [10, 25, 50, 100]
            });

            // Eventos de filtros
            $('#filtro-tipo').on('change', function() {
                const tipo = $(this).val();
                $('#filtro-especialidad').empty().append('<option value="">Todas</option>');
                if (tipo && tipoEspecialidad[tipo]) {
                    tipoEspecialidad[tipo].forEach(esp => 
                        $('#filtro-especialidad').append(`<option value="${esp}">${esp}</option>`));
                }
                filterTable();
            });

            $('#filtro-seccional, #filtro-especialidad, #filtro-plan').on('change', filterTable);

            // Botón reset
            $('#reset-btn').click(function() {
                $('#filtro-seccional, #filtro-tipo, #filtro-especialidad, #filtro-plan').val('');
                tabla.search('').columns().search('').draw();
            });

            // Mostrar/ocultar detalles
            $('#tabla-prestadores tbody').on('click', 'button.details-control', async function() {
                const tr = $(this).closest('tr');
                const row = tabla.row(tr);
                const rowData = row.data();

                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                    $(this).text('+');
                } else {
                    $(this).text('-');
                    // Agrupar prácticas por tipo
                    const practicesByType = {};
                    rowData.practices.forEach(practice => {
                        if (!practicesByType[practice.tipo]) {
                            practicesByType[practice.tipo] = [];
                        }
                        if (!practicesByType[practice.tipo].includes(practice.especialidad)) {
                            practicesByType[practice.tipo].push(practice.especialidad);
                        }
                    });

                    // Construir HTML para prácticas agrupadas
                    let practicesHtml = '<div class="practices-container">';
                    Object.keys(practicesByType).forEach(tipo => {
                        practicesHtml += `
                        <div class="practice-type-container">
                            <div class="practice-type-title">${tipo}</div>
                            <ul class="practice-list">`;
                        practicesByType[tipo].forEach(especialidad => {
                            practicesHtml += `<li>${especialidad}</li>`;
                        });
                        practicesHtml += `</ul></div>`;
                    });
                    practicesHtml += '</div>';

                    const mapId = `mapa-${(rowData.CUIT).replace(/\W/g,'')}-${(rowData.Domicilio).replace(/\W/g,'')}`;
                    let detalleHtml = `
                    <div class="details-child">
                        <table style="width:100%;">
                            <tr><th>Provincia:</th><td>${rowData.Provincia||'N/A'}</td></tr>
                            <tr><th>Partido:</th><td>${rowData.Partido||'N/A'}</td></tr>
                            <tr><th>Localidad:</th><td>${rowData.Localidad||'N/A'}</td></tr>
                            <tr><th>Domicilio:</th><td>${rowData.Domicilio||'N/A'}</td></tr>
                            <tr><th>Teléfono:</th><td>${rowData.Telefono||'N/A'}</td></tr>
                            <tr><th>Prácticas:</th><td>${practicesHtml}</td></tr>
                            <tr><th>Ubicación:</th>
                                <td><div id="${mapId}" class="map-container"></div></td>
                            </tr>
                        </table>
                    </div>`;
                    row.child(detalleHtml).show();
                    tr.addClass('shown');
                    
                    // Geocodificación y mapa
                    const address = [rowData.Domicilio, rowData.Localidad, rowData.Partido, rowData.Provincia].filter(Boolean).join(", ");
                    const coords = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                        .then(r=>r.json()).then(d=>d[0] ? {lat:+d[0].lat, lon:+d[0].lon} : null).catch(()=>null);
                    if (coords) {
                        const map = L.map(mapId).setView([coords.lat, coords.lon], 16);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'OpenStreetMap'}).addTo(map);
                        L.marker([coords.lat, coords.lon]).addTo(map).bindPopup(address).openPopup();
                    } else {
                        document.getElementById(mapId).innerHTML = "<div style='color:#b71c1c;padding:30px;text-align:center;'>No se pudo localizar la dirección.</div>";
                    }
                }
            });

            // Función para filtrar la tabla
            function filterTable() {
                const seccional = $('#filtro-seccional').val();
                const tipo = $('#filtro-tipo').val();
                const especialidad = $('#filtro-especialidad').val();
                const plan = $('#filtro-plan').val();

                // Aplicar filtros a las columnas
                tabla.column(3).search(seccional || '');
                tabla.column(4).search(plan || '');
                
                // Filtro por tipo y especialidad (requiere filtrado manual)
                if (tipo || especialidad) {
                    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                        const rowData = tabla.row(dataIndex).data();
                        if (!rowData) return true;
                        
                        // Verificar tipo
                        if (tipo) {
                            const hasTipo = rowData.practices.some(p => p.tipo === tipo);
                            if (!hasTipo) return false;
                        }
                        
                        // Verificar especialidad
                        if (especialidad) {
                            const hasEspecialidad = rowData.practices.some(p => p.especialidad === especialidad);
                            if (!hasEspecialidad) return false;
                        }
                        
                        return true;
                    });
                }
                
                tabla.draw();
                $.fn.dataTable.ext.search.pop(); // Limpiar filtro personalizado
            }
        }
    });
});
</script>
</body>
</html>
